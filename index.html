<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D ç…§ç‰‡è§€è³å™¨ - æ™ºèƒ½é›™æ¨¡å¼ç‰ˆ</title>
    <style>
        :root { --accent: #ffdd59; --bg: #0a0a0a; }
        * { box-sizing: border-box; }
        
        body {
            margin: 0; background: var(--bg); color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 20px; overflow-x: hidden;
        }
        
        /* 3D è¦–çª— */
        .viewport {
            position: relative; width: 92vw; max-width: 700px;
            margin: 30px auto; perspective: 1500px;
            perspective-origin: center center;
        }
        
        .photo-container {
            position: relative; width: 100%; border-radius: 25px;
            overflow: hidden; background: #000;
            box-shadow: 0 40px 80px rgba(0,0,0,0.9);
            transform-style: preserve-3d;
            transition: transform 0.35s cubic-bezier(0.16, 0.84, 0.44, 1),
                        box-shadow 0.35s ease;
            will-change: transform;
        }
        
        canvas { 
            display: block; width: 100%; height: auto;
            transition: transform 0.35s cubic-bezier(0.16, 0.84, 0.44, 1),
                        opacity 0.35s cubic-bezier(0.16, 0.84, 0.44, 1),
                        filter 0.25s ease;
            will-change: transform, opacity;
        }
        
        #canvasL, #canvasR { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%;
        }
        #canvasL { z-index: 1; }
        #canvasR { z-index: 2; }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls {
            width: 92vw; max-width: 700px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px; padding: 25px;
            margin: 20px auto;
        }
        
        .mode-switch {
            display: flex; gap: 10px; margin-bottom: 20px;
            background: rgba(0,0,0,0.3); padding: 5px; border-radius: 15px;
        }
        
        .mode-btn {
            flex: 1; padding: 12px 20px; border-radius: 12px;
            cursor: pointer; font-size: 14px; font-weight: 600;
            text-align: center; transition: 0.3s;
            background: transparent; color: rgba(255,255,255,0.6);
            border: 2px solid transparent;
        }
        
        .mode-btn.active {
            background: var(--accent);
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 221, 89, 0.3);
        }
        
        .mode-btn:hover:not(.active) {
            border-color: var(--accent);
            color: white;
        }
        
        .upload-zone {
            background: rgba(255,255,255,0.08);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 15px; padding: 30px;
            text-align: center; cursor: pointer;
            transition: 0.3s; margin-bottom: 20px;
        }
        
        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(255,221,89,0.1);
        }
        
        .upload-zone input { display: none; }
        
        .upload-icon {
            font-size: 48px; margin-bottom: 10px;
            opacity: 0.7;
        }
        
        .hint {
            font-size: 13px; color: rgba(255,255,255,0.5);
            text-align: center; margin-top: 15px;
        }
        
        .status {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4CAF50;
            padding: 12px 20px; border-radius: 8px;
            margin-top: 15px; font-size: 13px;
            display: none;
        }
        
        #authBtn {
            width: 100%; padding: 14px; border-radius: 12px;
            border: none; background: var(--accent);
            color: #000; font-weight: bold; font-size: 15px;
            cursor: pointer; margin-top: 20px;
            box-shadow: 0 5px 15px rgba(255, 221, 89, 0.4);
            transition: 0.3s;
        }
        
        #authBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 221, 89, 0.5);
        }
        
        .loading {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 30px 50px; border-radius: 20px;
            display: none; z-index: 1000;
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--accent);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>è™•ç†ä¸­...</div>
    </div>

    <div class="viewport" id="vbox">
        <div class="photo-container" id="photoContainer">
            <canvas id="canvasSingle"></canvas>
            <canvas id="canvasL" style="display:none;"></canvas>
            <canvas id="canvasR" style="display:none;"></canvas>
        </div>
    </div>

    <div class="controls">
        <div class="mode-switch">
            <div class="mode-btn" id="btnAI">
                ğŸ¤– AI æ·±åº¦<br>
                <span style="font-size:11px;opacity:0.7">å–®å¼µç…§ç‰‡</span>
            </div>
            <div class="mode-btn active" id="btnStereo">
                ğŸ‘ï¸ ç«‹é«”è¦–å·®<br>
                <span style="font-size:11px;opacity:0.7">å·¦å³çœ¼ç…§ç‰‡</span>
            </div>
        </div>
        
        <label class="upload-zone" id="uploadZone">
            <div class="upload-icon">ğŸ“¸</div>
            <div style="font-weight:600;margin-bottom:5px;">é»æ“Šä¸Šå‚³ç…§ç‰‡</div>
            <div style="font-size:12px;opacity:0.6;">
                ç«‹é«”æ¨¡å¼ï¼šè«‹ä¸Šå‚³å·¦å³çœ¼ä½µæ’çš„ç…§ç‰‡<br>
                AI æ¨¡å¼ï¼šä»»ä½•å–®å¼µç…§ç‰‡
            </div>
            <input type="file" id="imgInput" accept="image/*">
        </label>
        
        <div class="status" id="status">âœ“ ç…§ç‰‡å·²è¼‰å…¥</div>
        
        <button id="authBtn">é–‹å•Ÿé™€èºå„€ 3D æ¨¡å¼</button>
        
        <p class="hint">
            ğŸ’» æ»‘é¼ åœ¨ç…§ç‰‡ä¸Šè¼•æŸ”æ»‘å‹• | ğŸ“± å‚¾æ–œæ‰‹æ©Ÿæ„Ÿå— 3D
        </p>
    </div>

    <script>
        const cvSingle = document.getElementById('canvasSingle');
        const cvL = document.getElementById('canvasL');
        const cvR = document.getElementById('canvasR');
        const ctxSingle = cvSingle.getContext('2d');
        const ctxL = cvL.getContext('2d');
        const ctxR = cvR.getContext('2d');
        const pc = document.getElementById('photoContainer');
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');
        
        let currentMode = 'Stereo'; // 'AI' æˆ– 'Stereo'
        let originalImg = null;
        let depthMap = null; // AI æ¨¡å¼çš„æ·±åº¦åœ–
        let targetX = 0.5, targetY = 0.5;
        let currentX = 0.5, currentY = 0.5;
        
        // === æ¨¡å¼åˆ‡æ› ===
        document.getElementById('btnAI').onclick = function() {
            if (!originalImg) return;
            currentMode = 'AI';
            this.classList.add('active');
            document.getElementById('btnStereo').classList.remove('active');
            switchToMode();
        };
        
        document.getElementById('btnStereo').onclick = function() {
            if (!originalImg) return;
            currentMode = 'Stereo';
            this.classList.add('active');
            document.getElementById('btnAI').classList.remove('active');
            switchToMode();
        };
        
        function switchToMode() {
            if (currentMode === 'AI') {
                cvSingle.style.display = 'block';
                cvL.style.display = 'none';
                cvR.style.display = 'none';
                loadAIMode();
            } else {
                cvSingle.style.display = 'none';
                cvL.style.display = 'block';
                cvR.style.display = 'block';
                loadStereoMode();
            }
        }
        
        // === åœ–ç‰‡ä¸Šå‚³ ===
        document.getElementById('imgInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            loading.style.display = 'block';
            const reader = new FileReader();
            
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImg = img;
                    switchToMode();
                    status.style.display = 'block';
                    loading.style.display = 'none';
                };
                img.src = event.target.result;
            };
            
            reader.readAsDataURL(file);
        };
        
        // === AI æ·±åº¦æ¨¡å¼ ===
        function loadAIMode() {
            if (!originalImg) return;
            
            // ç°¡åŒ–ç‰ˆ AI æ·±åº¦ï¼šç”¨ä¸­å¿ƒè·é›¢æ¨¡æ“¬æ·±åº¦
            const w = originalImg.width;
            const h = originalImg.height;
            
            cvSingle.width = w;
            cvSingle.height = h;
            pc.style.aspectRatio = `${w}/${h}`;
            
            // å‰µå»ºç°¡å–®çš„å¾‘å‘æ·±åº¦åœ–ï¼ˆä¸­å¿ƒè¿‘ï¼Œé‚Šç·£é ï¼‰
            depthMap = createRadialDepthMap(w, h);
            
            renderAI(0.5, 0.5);
        }
        
        function createRadialDepthMap(w, h) {
            const map = [];
            const centerX = w / 2;
            const centerY = h / 2;
            const maxDist = Math.sqrt(centerX * centerX + centerY * centerY);
            
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const dx = x - centerX;
                    const dy = y - centerY;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const depth = 1 - (dist / maxDist); // 0-1ï¼Œä¸­å¿ƒç‚º 1
                    map.push(depth);
                }
            }
            return map;
        }
        
        function renderAI(percentX, percentY) {
            if (!originalImg || !depthMap) return;
            
            const centerOffsetX = (percentX - 0.5);
            const centerOffsetY = (percentY - 0.5);
            
            ctxSingle.clearRect(0, 0, cvSingle.width, cvSingle.height);
            
            // ğŸ¯ åˆ†å±¤æ¸²æŸ“ï¼šæ ¹æ“šæ·±åº¦åˆ† 3 å±¤
            const layers = [
                { range: [0, 0.33], shift: 1.5, blur: 4 },    // èƒŒæ™¯
                { range: [0.33, 0.66], shift: 1.0, blur: 1 }, // ä¸­æ™¯
                { range: [0.66, 1.0], shift: 0.5, blur: 0 }   // å‰æ™¯
            ];
            
            layers.forEach(layer => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = cvSingle.width;
                tempCanvas.height = cvSingle.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                // ç¹ªè£½è©²å±¤
                tempCtx.drawImage(originalImg, 0, 0);
                
                // æ‡‰ç”¨é®ç½©ï¼ˆåªä¿ç•™è©²æ·±åº¦ç¯„åœï¼‰
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                for (let i = 0; i < depthMap.length; i++) {
                    const depth = depthMap[i];
                    if (depth < layer.range[0] || depth > layer.range[1]) {
                        imageData.data[i * 4 + 3] = 0; // é€æ˜åŒ–
                    }
                }
                tempCtx.putImageData(imageData, 0, 0);
                
                // æ‡‰ç”¨ä½ç§»å’Œæ¨¡ç³Š
                ctxSingle.save();
                ctxSingle.filter = `blur(${layer.blur}px)`;
                const shiftX = centerOffsetX * 40 * layer.shift;
                const shiftY = centerOffsetY * 40 * layer.shift;
                ctxSingle.drawImage(tempCanvas, shiftX, shiftY);
                ctxSingle.restore();
            });
            
            // å®¹å™¨ 3D æ—‹è½‰
            const rotateY = centerOffsetX * 10;
            const rotateX = -centerOffsetY * 10;
            pc.style.transform = `
                rotateX(${rotateX}deg) 
                rotateY(${rotateY}deg)
                scale(1.03)
            `;
        }
        
        // === ç«‹é«”è¦–å·®æ¨¡å¼ï¼ˆè¶…ç´°è†©ç‰ˆï¼‰===
        function loadStereoMode() {
            if (!originalImg) return;
            
            const w = originalImg.width / 2;
            const h = originalImg.height;
            
            cvL.width = cvR.width = w;
            cvL.height = cvR.height = h;
            pc.style.aspectRatio = `${w}/${h}`;
            
            // ç¹ªè£½å·¦å³çœ¼
            ctxL.drawImage(originalImg, 0, 0, w, h, 0, 0, w, h);
            ctxR.drawImage(originalImg, w, 0, w, h, 0, 0, w, h);
            
            renderStereo(0.5, 0.5);
        }
        
        function renderStereo(percentX, percentY) {
            if (!originalImg) return;
            
            const centerOffsetX = (percentX - 0.5);
            const centerOffsetY = (percentY - 0.5);
            
            // ğŸ¯ Ease-Out æ›²ç·š
            const easeOut = (t) => 1 - Math.pow(1 - t, 3);
            const smoothOffsetX = centerOffsetX >= 0 
                ? easeOut(centerOffsetX * 2) * 0.5
                : -easeOut(-centerOffsetX * 2) * 0.5;
            
            // ğŸ¯ è¦–å·®ä½ç§»
            const maxShift = 25;
            const shiftL = smoothOffsetX * maxShift * 0.7;
            const shiftR = smoothOffsetX * maxShift * 1.3;
            
            // ğŸ¯ å‹•æ…‹ç¸®æ”¾
            const scaleBase = 1.08;
            const scaleDelta = Math.abs(smoothOffsetX) * 0.04;
            const scaleL = scaleBase + scaleDelta * 0.3;
            const scaleR = scaleBase + scaleDelta * 0.7;
            
            cvL.style.transform = `scale(${scaleL}) translateX(${shiftL}px)`;
            cvR.style.transform = `scale(${scaleR}) translateX(${shiftR}px)`;
            
            // ğŸ¯ S æ›²ç·šé€æ˜åº¦
            const smoothstep = (x) => x * x * (3 - 2 * x);
            const blendFactor = smoothstep(percentX);
            
            cvR.style.opacity = 0.3 + blendFactor * 0.7;
            cvL.style.opacity = 0.3 + (1 - blendFactor) * 0.7;
            
            // ğŸ¯ æ™¯æ·±æ¨¡ç³Š
            const blurAmount = Math.abs(centerOffsetX) * 0.5;
            cvL.style.filter = `blur(${blurAmount}px)`;
            cvR.style.filter = `blur(${blurAmount * 0.5}px)`;
            
            // ğŸ¯ å®¹å™¨ 3D æ—‹è½‰
            const rotateY = centerOffsetX * 8;
            const rotateX = -centerOffsetY * 8;
            
            pc.style.transform = `
                rotateX(${rotateX}deg) 
                rotateY(${rotateY}deg)
                scale(1.02)
            `;
            
            // ğŸ¯ å‹•æ…‹é™°å½±
            const shadowX = rotateY * 2.5;
            const shadowY = -rotateX * 2.5;
            const shadowBlur = 20 + (Math.abs(rotateY) + Math.abs(rotateX)) * 1.5;
            
            pc.style.boxShadow = `
                ${shadowX}px ${shadowY}px ${shadowBlur}px rgba(0,0,0,0.6),
                0 40px 80px rgba(0,0,0,0.9)
            `;
        }
        
        // === æ…£æ€§å‹•ç•« ===
        function animate() {
            const ease = 0.12;
            currentX += (targetX - currentX) * ease;
            currentY += (targetY - currentY) * ease;
            
            if (Math.abs(targetX - currentX) > 0.001 || Math.abs(targetY - currentY) > 0.001) {
                if (currentMode === 'AI') {
                    renderAI(currentX, currentY);
                } else {
                    renderStereo(currentX, currentY);
                }
                requestAnimationFrame(animate);
            }
        }
        
        // === äº’å‹• ===
        document.getElementById('vbox').onmousemove = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            targetX = (e.clientX - rect.left) / rect.width;
            targetY = (e.clientY - rect.top) / rect.height;
            requestAnimationFrame(animate);
        };
        
        document.getElementById('vbox').onmouseleave = () => {
            targetX = targetY = 0.5;
            requestAnimationFrame(animate);
        };
        
        // === é™€èºå„€ ===
        document.getElementById('authBtn').onclick = () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(s => {
                    if(s === 'granted') {
                        window.addEventListener('deviceorientation', handleMove);
                        document.getElementById('authBtn').textContent = 'âœ“ é™€èºå„€å·²å•Ÿå‹•';
                        document.getElementById('authBtn').style.background = '#4ade80';
                    }
                });
            } else {
                window.addEventListener('deviceorientation', handleMove);
                document.getElementById('authBtn').style.display = 'none';
            }
        };
        
        function handleMove(e) {
            if(!e.gamma || !e.beta) return;
            targetX = Math.max(0, Math.min(1, (e.gamma + 25) / 50));
            targetY = Math.max(0, Math.min(1, (e.beta + 25) / 50));
            requestAnimationFrame(animate);
        }
        
        // === é è¼‰ç¯„ä¾‹ï¼ˆå¯é¸ï¼‰===
        window.onload = () => {
            // å¦‚æœæœ‰é è¨­åœ–ç‰‡ï¼Œå¯ä»¥è‡ªå‹•è¼‰å…¥
            // loadDefaultImage();
        };
    </script>
</body>
</html>
